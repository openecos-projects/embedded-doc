# HP_UART API

## 目录

一、核心接口定义 (HP_UART APIs)

1. 串口初始化函数 (hp_uart_init)
2. 字符发送函数 (hp_uart_send)
3. 字符串发送函数 (hp_uart_send_str)
4. 字符接收函数 (hp_uart_recv)
5. 字符串接收函数 (hp_uart_recv_str)

## 详细介绍

### 一、核心接口定义 (HP_UART APIs)

#### 1. 串口初始化函数 (hp_uart_init)
（1）功能描述

这个函数用于对 UART 控制器进行参数配置，由于 UART 采用异步串行通信，必须在初始化阶段确保收发双方的波特率一致，并预设统一的数据帧格式。

（2）关键代码解析

```
// 引用自 hp_uart.c
// 波特率产生：根据系统频率计算分频系数，确保通信时钟同步
REG_UART_1_DIV = (CONFIG_CPU_FREQ_MHZ * 1000000 / baudrate) - 1; 
// 帧格式配置：通过 LCR 寄存器锁定 8 位数据、无校验、1 位停止位 
REG_UART_1_LCR = 0x1F;
```


* 时钟分频：REG_UART_1_DIV 决定了波形采样的脉冲间隔。

* 协议锁存：0x1F 是控制字的位组合映射,在写入该值后，硬件会自动在每一个字节前后添加起始位和停止位，无需软件干预。

#### 2. 字符发送函数 (hp_uart_send)
（1）功能描述

该函数可以将单个字节载入发送缓冲区，因为在执行写入操作前，驱动必须确认硬件发送单元处于空闲状态。

（2）关键代码解析

```
// 引用自 hp_uart.c
// 状态轮询：检测 LSR 寄存器 Bit 8
while (((REG_UART_1_LSR & 0x100) >> 8) == 1);
// 物理映射：将数据写入 TRX 寄存器触发并串转换
REG_UART_1_TRX = c;

```

* 同步机制：通过轮询 LSR 寄存器的状态位，确保数据流受控。只有当 Bit 8为 0，也可以说 FIFO 具备存储空间时，才会允许后续数据写入，从而规避数据溢出风险。

#### 3. 字符串发送函数 (hp_uart_send_str)
（1）功能描述

该函数是针对字符串数据的自动化传输封装，通过指针遍历内存空间，来实现连续的数据输出。

* 逻辑解析：内部采用 while (*str) 结构检测 C 语言标准字符串结束符。它通过串行循环调用 hp_uart_send 接口，将应用层文本转化为底层的字节流。

#### 4.字符接收函数 (hp_uart_recv)
（1）功能描述

该函数可以从接收缓冲区提取已采样完成的字节数据，接口采用阻塞式设计，直到硬件能捕捉到有效帧。

（2）关键代码解析

```
// 引用自 hp_uart.c
// 接收就绪检测：检测 LSR 第 7 位
while (((REG_UART_1_LSR & 0x080) >> 7) == 1);
*c = REG_UART_1_TRX;

```

* 有效性校验：LSR 寄存器的第 7 位是硬件状态的物理反馈,只有当该位指示数据已完整落入 TRX 缓存后，软件层才会提取数据，确保获取结果的准确性。

#### 5. 字符串接收函数 (hp_uart_recv_str)
（1）功能描述

该函数可以连续监听总线并存储字符，直到检测到换行符定界符为止，这个功能常用于构建串口人机交互指令。

（2）关键代码解析

```
// 引用自 hp_uart.c
if (*(str - 1) == '\n'){
    *str = '\0'; // 关键动作：手动补全 C 语言字符串结束符
    break;
}

```

* 协议转换：硬件层仅负责原始字节的传输,为了使接收到的数据能直接被应用层处理，驱动层通过识别 \n 来判定指令结束，并强制在末尾填充 \0。







