# QSPI API

## 目录

一、核心类型定义（QSPI Types）

1. 驱动配置结构体 (qspi_config_t)

二、配置体系（Configuration Object）

1. QSPI 初始化函数 (qspi_init)

三、功能接口（Functional APIs）

1. 基础单次写入函数 (qspi_write_8/16/32)

2. 批量式写入函数 (qspi_write_32xN)



## 详细介绍

### 一、核心类型定义（QSPI Types）

#### 1. 驱动配置结构体 (qspi_config_t)

（1）功能描述

用于定义QSPI 总线最基础的通信速率的一个轻量级配置包，因为QSPI 跟传统SPI一样属于同步通信协议，所以时钟频率的准确性直接决定了外设能否正确接收数据 。

（2）成员变量解析

* uint32_t clkdiv：QSPI时钟分频值。
  * 作用：通过对 APB 总线时钟进行分频来产生 SCK 时钟信号 。
  * 计算逻辑：SCK = APB_CLK / (2 * (div + 1))，具体需要根据相关外设支持的最大频率来计算并传入此值。

### 二、配置体系（Configuration Object）

#### 1. QSPI 初始化函数 (qspi_init)

（1）功能描述

作为 QSPI 驱动的总入口，该函数负责将硬件控制器从初始状态唤醒，并进行频率配置 。

* 硬件复位：函数内部通过对STATUS寄存器先置位（0x10）再清零的操作，实现控制器的逻辑复位。
* 环境清理：自动关闭所有QSPI中断并将Dummy时钟周期初始化为0，确保双方通信在一个干净的环境下开始 。
* 串口调试：函数内部会自动打印STATUS、INTCFG等核心寄存器的当前值，方便我们在串口就能确认初始化是否成功 。

（2）参数解析

* 参数：qspi_config_t *config
* 含义：指向已写好分频参数的配置结构体指针。

### 三、功能接口（Functional APIs）

#### 1. 基础单次写入函数 (qspi_write_8/16/32)

（1）功能描述

用于向总线发送单一的8/16/32位数据包，常用于发送指令或地址 。

* 数据自动对齐：为了匹配硬件32位发送FIFO且保证数据的高位在前、低位在后输出，函数内部会对8位和16位数据分别进行左移24位和16位处理 。
* 自动触发：函数在填充完 TXFIFO 后，通过向 STATUS 寄存器写入指令值258来启动物理传输 。该数值在底层对应二进制0b1_0000_0010其中Bit 1作为硬件启动信号负责扣动传输扳机，而Bit 8则用于锁定当前的传输模式 。这种将模式设定与启动信号打包为单一指令的操作，能够让硬件在接收到配置的同时立即执行，避免了多步操作可能带来的抖动或干扰。传输发起后，驱动进入同步阻塞状态，通过 while 循环不断轮询 STATUS 寄存器，直到硬件确认数据全部输出后才退出 。
* 阻塞等待：有一个同步阻塞接口，函数内部会通过while循环不断轮询 STATUS寄存器，直到硬件确认数据已全部吐出才会退出 。

（2）参数解析

* 参数：uint8_t/uint16_t/uint32_t data
* 含义：写入要发送的原始数值

#### 2. 批量式写入函数 (qspi_write_32xN)

（1）功能描述

当需要发送大段数据时，使用批量函数，目前该函数可以支持连续发送 2、8、16、32 个 32 位字 。不同于多次调用write_32，该函数仅需配置一次传输长度并只触发一次启动信号 。

* 底层优势：
  * 减少指令输入：通过一次性将所有待发数据推入TXFIFO硬件缓存 ，避免了多次启动或者停止硬件带来的时间间隔。
  * 数据连续：硬件方面保证了总线上的数据流是完全连续的，极大地提升了大数据量下的传输速率。

（2）参数解析

* 参数：data1~dataN
* 含义：按照发送顺序排列的 32 位原始数据。















