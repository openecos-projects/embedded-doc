## 简介
星空派采用的是SoC主板+FPGA核心板贴装设计，通过Chiplink协议进行访存。

![](../../../res/img/brd/starry-sky/v3.1/brd_func_top.png)

![](../../../res/img/brd/starry-sky/v3.1/brd_func_bot.png)

星空派外设和接口详细介绍如下：

- 系统
    - 1个电源开关、红色电源指示灯
    - 1个FPGA的JTAG调试烧录接口
    - 1个TypeC电源接口（同SoC的UART接口）
    - 1个2位的FPGA启动模式拨码开关
    - 1个拖拽式板载烧录器——HFP-Link
- SoC
    - 1个25MHz有源晶振，1个12.288MHz有源晶振
    - 1个FLASH插座，内置NOR FLASH芯片，SoC复位后会从该FLASH芯片取指
    - 1个UART接口，使用CP2102进行协议转换
    - 1个4位的PLL配置拨码开关
    - 1个5位的核选配置拨码开关
    - 1个复位按键
    - 1个PS2接口
    - 1个SPI屏幕接口
    - 2个独立按键
    - 4个独立LEDasd
    - 2个板载I2C设备（PCF8563BM/TR、AT24C64D-SSHM-T）
    - 1个SD卡卡槽
    - 1个40Pin的IO接口

星空派未对FPGA的IO进行扇出，此处不对FPGA进行过多介绍，感兴趣的同学可以在仓库里下载到相应资源，也可参考[星空V2.1](v2.1.md)的介绍文档。

## 开箱检查
拿到快递盒后，同学们需要确认是否有如下器件，若缺少物料请及时与项目组联系：

- 星空派板卡 * 1
- **MZ7X484-CORE** FPGA核心板 * 1
- 1.44吋 TFT 彩屏 * 1
- TypeC数据线 * 1
- 3D彩色打印的“一生一芯”Logo学号铭牌 * 1
- M3铜柱 * 4
- M3螺母 * 4

（配上一张开箱全家福）

## 上电测试
在该章节中，同学们需要完成以下内容的确认，后文会有更加详细的操作说明：

- PCB板卡是否可以正常上电
- FPGA板卡工作状态是否正常
- 默认测试程序是否正常工作

### 详细说明
#### 检查板卡上电状态
!!! danger "危险"
    勿将板卡放置在任何导体上！上电后请勿用手触摸板卡焊点焊盘裸露部分！！！

在板卡上电之前，将电源开关拨至断开状态（拨杆远离TypeC接口）。确认板卡开关状态及放置位置之后，使用TypeC数据线将板卡连接至电脑，闭合电源开关（拨杆靠近TypeC接口），观察TypeC接口附近的红色LED灯是否亮起。

![](../../../res/img/brd/starry-sky/v3.1/brd_pwr.png)

#### 检查FPGA工作状态
板卡上电之后，观察板卡底部的FPGA工作指示灯，一颗红色的电源指示灯，一颗蓝色的配置指示灯，FPGA正常工作时两颗LED保持常亮，如果蓝色LED灯没有亮起，请通过拨码开关将FPGA配置成FLASH模式。

![](../../../res/img/brd/starry-sky/v3.1/brd_fpga_led.png)
/// caption
FPGA正常工作指示灯
///

![](../../../res/img/brd/starry-sky/v3.1/brd_fpga_boot.png)
/// caption
FPGA启动模式选择
///

#### 测试默认程序是否正常工作
现在硬件上电测试部分已经完成，在软件测试之前你需要安装CP2102串口驱动以及一个串口终端，如果已经拥有串口测试环境请直接跳转至结果对照部分。

**串口驱动安装**

串口驱动的安装请参考[星空V2.1上电测试部分](v2.1.md#_4)。

**串口终端安装**

当电脑能够成功识别出串口的端口号后，还需要使用串口调试软件打开串口才能和板卡进行通信。目前市场上常用的串口调试软件有很多，比如Minicom、MobaXterm、Xshell、SecureCRT、Cutecom和WindTerm 等等，为了方便展示串口运行的结果，**本文档选择使用Tabby介绍后续的软件操作**（如果想要使用MobaXterm，可以参考[星空V2.1上电测试部分](v2.1.md#_4)）：

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby.png)

Tabby是一款全平台（Windows、Linux、MacOS）终端工具，支持SSH、serial、PowerShell、PS Core、WSL、Git-Bash、Cygwin、Cmder、CMD、SFTP等协议的强大的终端工具。请大家访问[Tabby](https://tabby.sh)的官网查看更加详细的介绍，根据自己的系统版本安装合适的Tabby版本。

完成Tabby安装后，打开软件，会看到如下的类似界面：

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_home.png)

然后按照下列图示，创建好对应的Serial终端窗口：

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_new.png)

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_cfg_new.png)

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_cfg_serial.png)

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_cfg_finish.png)

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_run.png)

![](../../../res/img/brd/starry-sky/v3.1/soft_tabby_finish.png)

（补充一张测试程序效果图）

## 程序编译与烧写
这一节将会介绍程序的编译与烧写过程，使得板卡可以运行其他对应的应用程序，而不仅仅是测试用例。烧写过程在星空V2.1文档部分已经有了详细的介绍，此处仅对差异部分进行介绍

### 程序的编译
本次星空派准备了半个编译环境（因为AM部分还是需要靠大家自己完成），可以在[StarrySkyPi](https://github.com/OSESO/StarrySkyPi)仓库中下载到对应的参考代码。

首先需要将`ysyx.h ysyx.c`两个文件添加至klib中，该头文件封装了外设的驱动函数，可以通过该头文件提供的API快速的调用外设，实现自己想实现的效果。欢迎大家提交PR，一起建设完善该头文件。

头文件添加完成之后，即可在`you_path/ysyx_env/prog/src`路径下使用`run.py`脚本进行编译，该脚本需要提供两个可选参数`APP_NAME`和`APP_TYPE`，具体使用大家自行`RTFSC`，参考如下：

![](../../../res/img/brd/starry-sky/v3.1/soft_riscv_build.png)

程序完成编译之后，会在`you_path/ysyx_env/prog/bin/mem`路径下生成对应的二进制文件。

!!! quote "将程序编译到SRAM中"
    星空派目前的mem依旧和星空V2.1一样，通过Chiplink访问FPGA上的内存颗粒，多总线的切换会让访存成为性能瓶颈，本次SoC片上集成了64K大小的SRAM，可以将比较小的程序编译到SRAM上运行，同时需要控制好堆栈位置及大小。如此一来，我们的芯片就可以丢下FPGA运行程序，嵌入式小系统的开发成为了可能。

### 程序的烧写
程序的烧写参考[星空V2.1](v2.1.md#_9)，星空派的烧写切换开关如下所示：

![](../../../res/img/brd/starry-sky/v3.1/brd_burn_mode.png)

## 硬件设计
### 概述
- 采用立创EDA进行原理图、PCB的设计，并在嘉立创进行PCB的生产和SMT制造
    - 采用四层叠层设计，叠层结构采用立创JLC04161H-3313叠层设计进行阻抗控制
    - 板卡机械尺寸为90mm*63mm，板厚1.6mm
    - 哑黑色阻焊，1u“沉金，外层铜厚1盎司，内层铜厚0.5盎司
- 等长控制
    - CHIPLINK 20mil
    - JTAG 20mil
    - USB 20mil
- 时钟晶振包地处理

### 原理图设计
星空派的电源从TypeC口引入，通过一个滑动开关及自恢复保险丝接入三路独立的LDO电路，分别降压为3.3V、1.8V、0.9V。当电源模块正常工作时，有一颗红色LED灯会亮起。

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_pwr.svg)
/// caption
电源模块
///

芯片外围电路包含时钟电路、核选电路、PLL配置电路、复位电路。

- 时钟电路采用了两颗有源晶振，25MHz为核心提供时钟，12.288MHz为外设提供时钟
- 核选及PLL电路采用拨码开关正逻辑设计
- 复位电路采用了一颗复位专用芯片，可以产生一个比较完善的复位信号给到芯片，防止电路中的干扰影响复位信号

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_chip.svg)
/// caption
芯片外围
///

FPGA外围电路中与星空V2.1不同的地方在于**BOOT MODE**拨码开关也改为了正逻辑操作

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_fpga.svg)
/// caption
FPGA外围
///

外部接口：

- 与FPGA连接的四个BTB连接器
- 用于供电及串口连接的TypeC接口
- GPIO功能引脚扇出

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_io.svg)
/// caption
外部接口
///

存储模块:

- 基于CH32V103C8T6的拖拽式下载器——HFP_LINK
- SD卡连接器

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_mem.svg)
/// caption
存储模块
///

板载外设：

- PS2接口进行了5V与1.8V的电平转换
- I2C部分经过1.8V转3.3V之后连接了PCF8563 RTC时钟、AT24C64D存储器
- 独立按键上拉4.7K电阻
- 连接LED的IO默认上拉，LED灯串联4.7K电阻进行限流
- SPI屏幕接口（2.54mm母座）* 1

![](../../../res/img/brd/starry-sky/v3.1/brd_sch_perip.svg)
/// caption
板载外设
///

### PCB 3D视图
![](../../../res/img/brd/starry-sky/v3.1/brd_pcb_top.png)
/// caption
PCB正面渲染图
///

![](../../../res/img/brd/starry-sky/v3.1/brd_pcb_bot.png)
/// caption
PCB背面渲染图
///

### SMT 3D视图
![](../../../res/img/brd/starry-sky/v3.1/brd_smt_top.png)
/// caption
SMT正面渲染图
///

![](../../../res/img/brd/starry-sky/v3.1/brd_smt_bot.png)
/// caption
SMT背面渲染图
///

## 勘误与致谢
### 如何联系我
请在该[仓库](https://github.com/ecoslab/embedded-doc)下提出您宝贵的意见

### 致谢列表
- [maksyuki](https://github.com/maksyuki)

> 作者：李好（XHTimmo）、缪宇飏（myyerrol）
